# Recipe: REST with Consul and Apache httpd
Тут мы рассмотрим реализацию синхронной микросервисной архитектуры с Consul и сервером Apache httpd в которой:
- Consul выполняет роль service discovery
- Apache httpd используется для балансировки и маршрутизации HTTP запросов
- Consul Template создает конфигурационные файл для Apache httpd включающие информации о зараегистрированных сервисах, а так же настраивает и перезапускает Apache при регистрации нового сервиса.

Приложение доступно по адресу [https://github.com/ewolff/microservice-consul](https://github.com/ewolff/microservice-consul/blob/master/HOW-TO-RUN.md).

## Пример
Структуру приложения можно увидеть на картинке:
- Catalog управляет информацией типа стоимости и названия товаров, которые могут быть заказаны
- Customer хранит данные пользователей
- Order может принимать новые заказы. Он использует сервисы Catalog и Customer.

![](attachments/Pasted%20image%2020220508012422.png)

### Аритектура
Три микросервиса представляют их UI и REST-интерфейсы на порту 8080. Они доступны только внутри сети Docker. 

Consul предоставляет UI и REST-интерфейс на порту  8500 и  DNS по протоколу UDP на порту 8600 - эти порты доступны вне контейнеров для подключения снаружи. 

Также на порту 8080 наружу смотрит Apache httpd, он форвардит запросы ко внутренним микросервисам.

![](attachments/Pasted%20image%2020220508020520.png)

## Service Discovery
[Consul](http://www.consul.io/) - это реализует технологию обнаружение сервисов.

Consul поддерживает HTTP REST и DNS.

С помощью Consul Template Consul может генерировать файлы конфигураций
- Файлы могут содержать IP адрес и порты известных сервисов
- Это позволяет управляеть приложенями, которые не умеют работать с REST API
- Сервисы могут обновлять свое состояние с помощью health check

Consul может выполнять проверки сервисов и исключить их из использования, когда проверка проваливается. Примером проверки может являться обращенние к заданному HTTP-ресурсу.

Consul поддерживает репликацию и может обеспечивать высокую надежность. Если один из серверов Consul упадет, другие могут компенсировать его падение воспользовавшись реплицированными данными.

Consul может быть распределен по нескольким датацентрам.
- Данные могут быть реплицированы между датацентрами для повышения доступности
- Поиск сервисов может быть ограничен областью того же датацентра
- Сервисы в том же датацентре обычно предоставляют большую поизводительность

Наконец Consul может быть использован для настройки самих сервисов.

### Consult Dashboard
Информация о зарегистрированных сервисах доступна через дашборд. Он показывает все сервисы которые зарегистировались в Consul включая результаты проверки их состояния.

![](attachments/Pasted%20image%2020220508025849.png)

### Получение данных через DNS
Информацию о сервисе можно получить через DNS запрос. Например, чтобы получить IP-адрес сервиса Order можно воспользоваться таким запросом:
```sh
dig @localhost -p 8600 order.service.consul.
```

Чтобы получить IP-адрес и порт по которому доступен сервис нужно воспользоваться таким запросом:
```sh
dig @localhost -p 8600 order.service.consul. SRV
```

## Маршрутизация: Apache httpd
В то время как обычный прокси позволяет обрабатывать трафик из приватной сети в публичную, реверсивный прокси обрабатывает входящий трафик. Он перенаправляет внешние запросы к отдельным сервисам. Таким образом все внутренние сервисы могут быть доступны снаружи по одному адресу.

Плюс к этому httpd выполняет балансировку нагрузки. В данном пример httpd используется и в качестве реверсивного прокси и для балансировки нагрузки.

Запросы микросервисов друг к другу выполняются без участия прокси. Для их балансировки используется библиотеку Ribbon, выполняющая клиентскую балансировку.

Кроме Apache httpd можно использовать Nginx или легковесные решения типа [Fabio](https://github.com/eBay/fabio) специально созданные для балансировки нагрузки микросервисов.

## Consul Template
Apache httpd нужно настраивать отдельно для каждого микросервиса. Это можно сделать с помощью [Consul Template](https://github.com/hashicorp/consul-template).

### Шаблон
Шаблон выглядит примерно так. Похоже это Go Templates
```
{{range services}}<Proxy balancer://{{.Name}}>{{range service .Name}}  BalancerMember http://{{.Address}}:{{.Port}}{{end}}</Proxy>  ProxyPass        /{{.Name}} balancer://{{.Name}}  ProxyPassReverse /{{.Name}} balancer://{{.Name}}{{end}}
```

### Запуск
Consul Template запускается такой вот командой в контейнере docker/apache:
```bash
CMD /usr/bin/consul-template -log-level info -consul consul:8500 \\  -template "/etc/apache2/sites-enabled/000-default.ctmpl:/etc/apache2/sites-enabled/000-default.conf:apache2ctl -k graceful"
```

Тут важно заметить, что он сам управляет запуском и перезапуском веб-сервера, это означает, что его нужно запускать в том же контейнере, что и веб-сервер. Это противоречит идеологии Docker, но является вынуженной мерой.

## DNS и Регистратор
У микросервисов есть зависимость на уровне кода от Consul API для регистрации. В принципе, можно обойтись и без этого если воспользоваться [Registrator](https://github.com/gliderlabs/registrator) и сконфигурировать контейнеры Docker таким образом чтобы они использовали Consul в качестве DNS сервера.

- Registrator запускается в Docker контейнере. С помощью сокета Registrator подключается к Docker и собирает информацию обо всех запускаемых контейнерах.
- DNS от Consul висит на дефолтном порту 53 UDP.
- Docker контейнеры используют Docker host как DNS сервер.

![](attachments/Pasted%20image%2020220508125431.png)

Пример сервиса реализующего такую архитектуру можно найти тут [https://github.com/ewolff/microservice-consul-dns](https://github.com/ewolff/microservice-consul-dns).

### Конфигурация через перменные окружения
Сервисы также могут конфигурироваться через переменные окружения с помощью [Envconsul](https://github.com/hashicorp/envconsul).


