# Recipe: Server-side Integration using Edge Side Icludes (ESI)
## Концепция ESI
ESI позволяет веб-приложениям интегрировать фрагменты HTML из других приложений. Для этого веб-приложения отправляют HTML-код содержащий ESI-тэги.

![](attachments/Pasted%20image%2020220502034534.png)

## Кеш реализующий ESI
В примере выше ESI реализуется кеширующим прокси Varnish. Другие кеши типа Squid также поддерживают ESI. Кеширующие прокси используются для ускорения отдачи контента и снижения нагрузки на систему.

## CDN реализующие ESI
CDN типа Akamai тоже могут поддерживать ESI. 

Статические части страницы могут кешироваться в то время как динамические части будут подгружаться заново. Таким образом ESI не тольк используется для интеграции фронтенда, но и улучшает производительность помогая кешировать статический контент.

## Varnish
Varnish - это кеширующий прокси. Его алгоритм работы прост:
- Перехватывает запросы к веб-серверу
- Кеширует ответы
- Форвардит только те запросы к веб-северу, которых нет в кеше

![](attachments/Pasted%20image%2020220502111759.png)

Varnish использует собственные HTTP-заголовки для управления процессом кеширования.

Пример конфигурации Varnish:
```
vcl 4.0;

backend default {
	.host = "order";
	.port = "8080";
}

backend common {
	.host = "common";
	.port = "8180";
} 

sub vcl_recv vcl_recv {
	if (req.url ~ "^/common") {
		set req.backend_hint = common;
	}
}
 
sub vcl_backend_response{
	set beresp.do_esi = true;
	set beresp.ttl = 30s;
	set beresp.grace = 15m;
}
```

Тут описаны два бекенда: common и default. Когда поступает запрос начинающийся на `/common`, Varnish отправляет его на соответствующий бекенд.

Конструкция `set beresp.do_esi = true;` заставляет Varnish интепретировать ESI-теги.

### Пример приложения использующего Varnish
Тут [https://github.com/ewolff/SCS-ESI](https://github.com/ewolff/SCS-ESI) можно найти пример приложения, использующего Varnish для реализации ESI.

![](attachments/Pasted%20image%2020220502113814.png)

Оно состоит из двух частей: common содержит общий шаблон и стили, order-api - информацию о заказах.
## Проблемы тестирования
Приложения использующие ESI бывает сложно тестировать в отсутствии инфраструктуры, таким образом для комфортной разработки и тестирования необходимо наличие работающего Varnish, чтобы прогонять через него запросы.

## Вариации
### Другие реализации ESI
Есть и другие продукты релизующие ESI, такие как Squid или CDN Akamai.

### SSI
Кроме того есть SSI (Server-side includes). Это фича, предоставляемая большинством веб-серверов. Пример приложения, которое использует SSI: [https://scs-commerce.github.io/](https://scs-commerce.github.io/).

ESI можно сравнить с SSI:
- Веб-сервера часто уже доступны в инфраструктуре, тогда как кеш нужно настраивать отдельно
- Кеш не только ускоряет приложение, но и нивелирует отдельные сбои.

### Tailor
[Tailor](https://github.com/zalando/tailor) это сервер-сайд вариант интеграции фронтенда созданный в Zalando. Он оптимизирован для как можно более скорого отбражения HTML кода пользователю. Сначала подгружается каркас приложения, потом он дополняется на стороне пользователя средствами JavaScript. Tailor реализован на Node.js.

### Клиентская интеграция
Интеграция на клиенте не требует никакой дополнительной инфраструктуры, так что ее можно использовать как более простую альтернативу. Она отлично подходит для отображения опциональных элементов на странице.

Для интеграции заголовка и подвала страницы уместнее использовать server-side интеграцию, т.к. страница не может быть корректно отображена без этих элементов.

### Разделяемая библиотека
Теоретически общие части HTML могут поставляться в виде разделяемой библиотеки, но это создает лишние зависимости между сервисами. При изменении общей части их нужно было бы собирать заново.

